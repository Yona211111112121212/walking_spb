name: CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Debug - Show exact directory names
      run: |
        echo "üìÅ Current directory: $(pwd)"
        echo "üìÅ Listing ALL directories (including hidden):"
        ls -la
        echo ""
        echo "üìÅ Looking for backend folder..."
        find . -maxdepth 1 -type d -name "*back*" -o -name "*Back*" | sort
        echo ""
        echo "üìÅ Contents of root directory:"
        for item in *; do
          if [ -d "$item" ]; then
            echo "üìÇ Directory: $item"
          elif [ -f "$item" ]; then
            echo "üìÑ File: $item"
          fi
        done
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Find and Install Backend Dependencies
      run: |
        echo "üîç Looking for backend directory..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–º–µ–Ω
        if [ -d "Backet" ]; then
          echo "‚úÖ Found 'Backet' directory"
          BACKEND_DIR="Backet"
        elif [ -d "backend" ]; then
          echo "‚úÖ Found 'backend' directory"
          BACKEND_DIR="backend"
        elif [ -d "BackEnd" ]; then
          echo "‚úÖ Found 'BackEnd' directory"
          BACKEND_DIR="BackEnd"
        elif [ -d "backet" ]; then
          echo "‚úÖ Found 'backet' directory"
          BACKEND_DIR="backet"
        else
          echo "‚ùå No backend directory found!"
          echo "Available directories:"
          ls -d */
          exit 1
        fi
        
        echo "üì¶ Installing dependencies in $BACKEND_DIR..."
        cd "$BACKEND_DIR"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º package.json
        if [ ! -f "package.json" ]; then
          echo "‚ùå package.json not found in $BACKEND_DIR!"
          ls -la
          exit 1
        fi
        
        echo "üìÑ package.json contents:"
        cat package.json | head -20
        
        npm install
        echo "‚úÖ Dependencies installed in $BACKEND_DIR"
    
    - name: Check Backend Files
      run: |
        echo "üîç Checking backend files..."
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–Ω–æ–≤–∞
        if [ -d "Backet" ]; then
          BACKEND_DIR="Backet"
        elif [ -d "backend" ]; then
          BACKEND_DIR="backend"
        else
          BACKEND_DIR=$(find . -maxdepth 1 -type d -name "*back*" -o -name "*Back*" | head -1)
        fi
        
        cd "$BACKEND_DIR"
        echo "Working in directory: $(pwd)"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
        echo "üìÑ Checking essential files:"
        
        if [ -f "server.js" ]; then
          echo "‚úÖ Found server.js"
          echo "First 10 lines of server.js:"
          head -10 server.js
        else
          echo "‚ùå server.js not found!"
          echo "Available .js files:"
          ls *.js 2>/dev/null || echo "No .js files found"
          exit 1
        fi
        
        if [ -f "database.js" ]; then
          echo "‚úÖ Found database.js"
        else
          echo "‚ö†Ô∏è database.js not found (might be normal)"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
        echo "üß™ Checking JavaScript syntax..."
        if node -c server.js; then
          echo "‚úÖ server.js syntax is valid"
        else
          echo "‚ùå server.js has syntax errors"
          exit 1
        fi
    
    - name: Find and Install Frontend Dependencies
      run: |
        echo "üîç Looking for frontend directory..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–º–µ–Ω
        if [ -d "frontend" ]; then
          echo "‚úÖ Found 'frontend' directory"
          FRONTEND_DIR="frontend"
        elif [ -d "Frontend" ]; then
          echo "‚úÖ Found 'Frontend' directory"
          FRONTEND_DIR="Frontend"
        elif [ -d "FrontEnd" ]; then
          echo "‚úÖ Found 'FrontEnd' directory"
          FRONTEND_DIR="FrontEnd"
        else
          echo "‚ö†Ô∏è No frontend directory found, skipping frontend steps"
          exit 0  # –ù–µ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø–∞–π–ø–ª–∞–π–Ω, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        fi
        
        echo "üì¶ Installing dependencies in $FRONTEND_DIR..."
        cd "$FRONTEND_DIR"
        
        if [ ! -f "package.json" ]; then
          echo "‚ùå package.json not found in $FRONTEND_DIR!"
          ls -la
          exit 1
        fi
        
        npm install
        echo "‚úÖ Frontend dependencies installed"
    
    - name: Build Frontend (if exists)
      run: |
        if [ -d "frontend" ]; then
          FRONTEND_DIR="frontend"
        elif [ -d "Frontend" ]; then
          FRONTEND_DIR="Frontend"
        else
          echo "‚ÑπÔ∏è Frontend directory not found, skipping build"
          exit 0
        fi
        
        cd "$FRONTEND_DIR"
        echo "üèóÔ∏è Building frontend..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º App.js
        if [ -f "src/App.js" ]; then
          echo "‚úÖ Found src/App.js"
          node -c src/App.js && echo "‚úÖ App.js syntax valid"
        fi
        
        # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å
        CI=false npm run build || echo "‚ö†Ô∏è Build may have warnings"
        
        if [ -d "build" ] || [ -d "dist" ]; then
          echo "‚úÖ Frontend built successfully"
        else
          echo "‚ö†Ô∏è Build output directory not found"
        fi
    
    - name: Success
      run: |
        echo "üéâ CI Pipeline completed successfully!"
        echo "‚úÖ Backend: Dependencies installed and syntax checked"
        echo "‚úÖ Frontend: Built (if exists)"
        echo ""
        echo "Summary:"
        echo "- $(date)"
        echo "- Branch: ${{ github.ref }}"
        echo "- Commit: ${{ github.sha }}"
        name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install Backend Dependencies
      run: |
        cd Backet
        npm install
    
    - name: Check Backend Syntax
      run: |
        cd Backet
        node -c server.js
        echo "‚úÖ Backend syntax OK"
    
    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm install
    
    - name: Build Frontend
      run: |
        cd frontend
        CI=false npm run build
        echo "‚úÖ Frontend built"

  deploy:
    needs: test  # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Build Frontend for Deployment
      run: |
        cd frontend
        npm install
        CI=false npm run build
    
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: frontend/build  # –∏–ª–∏ frontend/dist –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        branch: gh-pages  # –í–µ—Ç–∫–∞ –¥–ª—è GitHub Pages
        clean: true