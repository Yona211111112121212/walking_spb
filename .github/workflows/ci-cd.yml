name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

env:
  NODE_VERSION: '18'

jobs:
  test-backend:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: walking_service_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 040506
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm ci
    
    - name: Check Backend Syntax
      run: |
        cd backend
        echo "ğŸ” Checking backend syntax..."
        node -c server.js && echo "âœ… server.js syntax OK"
        if [ -f "database.js" ]; then
          node -c database.js && echo "âœ… database.js syntax OK"
        fi
    
    - name: Test Database Connection
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: walking_service_db
        DB_USER: postgres
        DB_PASSWORD: 040506
        JWT_SECRET: my_super_secret_key
      run: |
        cd backend
        echo "ğŸ§ª Testing database connection..."
        
        cat > test-db.js << 'EOF'
        const { Pool } = require('pg');
        
        const pool = new Pool({
          host: process.env.DB_HOST,
          port: process.env.DB_PORT,
          database: process.env.DB_NAME,
          user: process.env.DB_USER,
          password: process.env.DB_PASSWORD
        });
        
        pool.query('SELECT NOW() as time')
          .then(result => {
            console.log('âœ… Database connected! Time:', result.rows[0].time);
            process.exit(0);
          })
          .catch(error => {
            console.error('âŒ Database error:', error.message);
            process.exit(1);
          })
          .finally(() => pool.end());
        EOF
        
        node test-db.js
    
    - name: Test Server Startup
      env:
        JWT_SECRET: my_super_secret_key
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: walking_service_db
        DB_USER: postgres
        DB_PASSWORD: 040506
        PORT: 5000
      run: |
        cd backend
        echo "ğŸš€ Testing server startup..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ .env Ñ„Ğ°Ğ¹Ğ»
        echo "JWT_SECRET=my_super_secret_key" > .env.test
        echo "DB_HOST=localhost" >> .env.test
        echo "DB_PORT=5432" >> .env.test
        echo "DB_NAME=walking_service_db" >> .env.test
        echo "DB_USER=postgres" >> .env.test
        echo "DB_PASSWORD=040506" >> .env.test
        echo "PORT=5000" >> .env.test
        
        # Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
        export $(grep -v '^#' .env.test | xargs)
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€ Ğ² Ñ„Ğ¾Ğ½Ğµ
        node server.js &
        SERVER_PID=$!
        
        # Ğ–Ğ´ĞµĞ¼ 3 ÑĞµĞºÑƒĞ½Ğ´Ñ‹
        sleep 3
        
        if ps -p $SERVER_PID > /dev/null; then
          echo "âœ… Server started successfully (PID: $SERVER_PID)"
          kill $SERVER_PID 2>/dev/null || true
        else
          echo "âŒ Server failed to start"
          exit 1
        fi

  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Check Frontend Syntax
      run: |
        cd frontend
        echo "ğŸ” Checking frontend syntax..."
        if [ -f "src/App.js" ]; then
          node -c src/App.js && echo "âœ… App.js syntax OK"
        fi
        if [ -f "src/index.js" ]; then
          node -c src/index.js && echo "âœ… index.js syntax OK"
        fi
    
    - name: Build Frontend
      run: |
        cd frontend
        echo "ğŸ—ï¸ Building frontend..."
        CI=false npm run build
        
        if [ -d "build" ]; then
          echo "âœ… Build created in frontend/build/"
          ls -la build/
        elif [ -d "dist" ]; then
          echo "âœ… Build created in frontend/dist/"
          ls -la dist/
        else
          echo "âŒ No build directory created"
          exit 1
        fi

  deploy:
    needs: [test-backend, test-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Build Frontend for Deployment
      run: |
        cd frontend
        npm ci
        CI=false npm run build
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ GitHub Pages
        touch build/.nojekyll  # ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Jekyll Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ
        
        # Ğ•ÑĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚Ğµ React Router
        cp build/index.html build/404.html
        
        echo "ğŸ“Š Build information:"
        echo "- Files in build/:"
        ls -la build/
        echo "- Total size:"
        du -sh build/
    
    - name: Setup Pages
      uses: actions/configure-pages@v3
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: './frontend/build'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
    
    - name: Show Deployment Info
      if: success()
      run: |
        echo "ğŸ‰ ==========================================="
        echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
        echo "ğŸ‰ ==========================================="
        echo ""
        echo "ğŸŒ Your site is now live at:"
        echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "ğŸ“Š Deployment details:"
        echo "   - Branch: ${{ github.ref }}"
        echo "   - Commit: ${{ github.sha }}"
        echo "   - Time: $(date)"
        echo ""
        echo "ğŸ”— Click the 'github-pages' environment link above"
        echo "   to visit your site directly from GitHub!"
        echo ""
        echo "ğŸ”„ Next update: Push to main branch"