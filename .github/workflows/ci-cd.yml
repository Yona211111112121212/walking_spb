name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

env:
  NODE_VERSION: '18'

jobs:
  test-backend:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: walking_service_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 040506
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install Backend Dependencies
      run: |
        echo "ğŸ“¦ Installing backend dependencies..."
        cd backend
        npm install --no-audit
    
    - name: Test Backend Database Connection
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: walking_service_db
        DB_USER: postgres
        DB_PASSWORD: 040506
        JWT_SECRET: my_super_secret_key
      run: |
        echo "ğŸ§ª Testing database connection..."
        cd backend
        
        cat > test-db.js << 'EOF'
        console.log("Testing database connection...");
        try {
          const pg = require('pg');
          console.log("âœ… PostgreSQL module loaded successfully");
          process.exit(0);
        } catch (error) {
          console.error("âŒ Error loading pg module:", error.message);
          process.exit(1);
        }
        EOF
        
        node test-db.js

  build-and-deploy-frontend:
    # Ğ­Ñ‚Ğ¾Ñ‚ job Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install Dependencies
      run: |
        echo "ğŸ“¦ Installing frontend dependencies..."
        cd frontend
        npm install --no-audit
    
    - name: Build Frontend
      run: |
        echo "ğŸ—ï¸ Building frontend..."
        cd frontend
        CI=false npm run build
        
        # ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ GitHub Pages
        touch build/.nojekyll
        cp build/index.html build/404.html
        
        echo "âœ… Build completed. Contents of build/:"
        ls -la build/
    
    - name: Upload Artifact for GitHub Pages
      # Ğ¨Ğ°Ğ³ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ˜ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°. Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ² Ğ­Ğ¢ĞĞœ Ğ–Ğ• job, Ğ³Ğ´Ğµ Ğ±Ñ‹Ğ»Ğ° ÑĞ±Ğ¾Ñ€ĞºĞ°.
      uses: actions/upload-pages-artifact@v3
      with:
        path: './frontend/build'

  deploy-to-github-pages:
    # Ğ­Ñ‚Ğ¾Ñ‚ job Ğ—ĞĞ’Ğ˜Ğ¡Ğ˜Ğ¢ Ğ¾Ñ‚ job Ñ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ¼ Ğ¸ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´ĞµĞ¿Ğ»Ğ¾ĞµĞ¼
    needs: build-and-deploy-frontend
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    
    # ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ GitHub Pages
    permissions:
      pages: write      # Ğ”Ğ°ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼ Pages
      id-token: write   # ĞÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
    
    # Ğ¡Ğ²ÑĞ·ÑŒ Ñ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸ĞµĞ¼ GitHub Pages (Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ ÑÑÑ‹Ğ»ĞºĞ° Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        # Ğ¨Ğ°Ğ³ Ğ ĞĞ—Ğ’Ğ•Ğ Ğ¢Ğ«Ğ’ĞĞĞ˜Ğ¯. ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚, Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ² Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¼ job.
        uses: actions/deploy-pages@v4