name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ğ”Ğ»Ñ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-backend:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: walking_service_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 040506
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Backend Dependencies
      run: |
        echo "ğŸ“¦ Installing backend dependencies..."
        cd backend
        npm install --no-audit
    
    - name: Test Backend Database Connection
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: walking_service_db
        DB_USER: postgres
        DB_PASSWORD: 040506
        JWT_SECRET: my_super_secret_key
      run: |
        echo "ğŸ§ª Testing database connection..."
        cd backend
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ñ‚ĞµÑÑ‚
        cat > test-db.js << 'EOF'
        console.log("Testing database connection...");
        
        // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº pg
        try {
          const pg = require('pg');
          console.log("âœ… PostgreSQL module loaded successfully");
          process.exit(0);
        } catch (error) {
          console.error("âŒ Error loading pg module:", error.message);
          process.exit(1);
        }
        EOF
        
        node test-db.js
    
    - name: Check Backend Server File
      run: |
        echo "ğŸ” Checking backend server.js..."
        cd backend
        
        if [ -f "server.js" ]; then
          echo "âœ… server.js found"
          # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°, Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ» ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
          if [ -s "server.js" ]; then
            echo "âœ… server.js is not empty"
            head -5 server.js
          fi
        else
          echo "âŒ server.js not found"
          exit 1
        fi

  build-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Frontend Dependencies
      run: |
        echo "ğŸ“¦ Installing frontend dependencies..."
        cd frontend
        npm install --no-audit
    
    - name: Build Frontend
      run: |
        echo "ğŸ—ï¸ Building frontend..."
        cd frontend
        
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ React
        export CI=false
        
        # ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
        npm run build
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ÑĞ±Ğ¾Ñ€ĞºĞ¸
        if [ -d "build" ]; then
          echo "âœ… Build directory created successfully"
          echo "ğŸ“ Contents of build directory:"
          ls -la build/
          echo "ğŸ“Š Total size:"
          du -sh build/
        else
          echo "âŒ Build directory not created!"
          exit 1
        fi

  deploy:
    needs: [test-backend, build-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install and Build
      run: |
        echo "ğŸ”§ Preparing for deployment..."
        cd frontend
        
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
        npm install --no-audit
        
        # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
        CI=false npm run build
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ GitHub Pages
        echo "Creating .nojekyll file..."
        touch build/.nojekyll
        
        echo "Creating 404.html for React Router..."
        cp build/index.html build/404.html
        
        echo "âœ… Build completed"
    
    - name: Setup Pages
      uses: actions/configure-pages@v3
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v4
      with:
        path: './frontend/build'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
    
    - name: Deployment Success Message
      run: |
        echo "ğŸ‰ ==========================================="
        echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
        echo "ğŸ‰ ==========================================="
        echo ""
        echo "ğŸŒ Your site is now live at:"
        echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "ğŸ“Š Details:"
        echo "   - Branch: ${{ github.ref }}"
        echo "   - Commit: ${{ github.sha }}"
        echo "   - Time: $(date)"
        echo ""
        echo "ğŸ”— You can also find the link in the 'github-pages' environment above"