name: CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: walking_service_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 040506
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        # –£–ë–ò–†–ê–ï–ú cache: 'npm' –∏–ª–∏ –ø—Ä–∞–≤–∏–º –µ–≥–æ
        # cache: 'npm'  # –£–î–ê–õ–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ö–£
    
    - name: Install Backend Dependencies
      run: |
        if [ -d "Backet" ]; then
          cd Backet
        elif [ -d "backend" ]; then
          cd backend
        fi
        npm ci
    
    - name: Run Backend Tests
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: walking_service_db
        DB_USER: postgres
        DB_PASSWORD: 040506
        JWT_SECRET: my_super_secret_key
        NODE_ENV: test
      run: |
        if [ -d "Backet" ]; then
          cd Backet
        elif [ -d "backend" ]; then
          cd backend
        fi
        # Create a simple test script if tests don't exist
        if [ ! -f "test.js" ]; then
          cat > test.js << 'EOF'
          const { Pool } = require('pg');
          
          async function testDatabase() {
            try {
              const pool = new Pool({
                host: process.env.DB_HOST,
                port: process.env.DB_PORT,
                database: process.env.DB_NAME,
                user: process.env.DB_USER,
                password: process.env.DB_PASSWORD
              });
              
              const result = await pool.query('SELECT NOW()');
              console.log('‚úÖ Database connection successful:', result.rows[0]);
              process.exit(0);
            } catch (error) {
              console.error('‚ùå Database connection failed:', error.message);
              process.exit(1);
            }
          }
          
          testDatabase();
          EOF
        fi
        node test.js
    
    - name: Check Backend Server Starts
      env:
        JWT_SECRET: my_super_secret_key
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: walking_service_db
        DB_USER: postgres
        DB_PASSWORD: 040506
      run: |
        if [ -d "Backet" ]; then
          cd Backet
        elif [ -d "backend" ]; then
          cd backend
        fi
        # Try to start server and check if it starts without errors
        timeout 10s node server.js & 
        SERVER_PID=$!
        sleep 3
        if ps -p $SERVER_PID > /dev/null; then
          echo "‚úÖ Server started successfully"
          kill $SERVER_PID
        else
          echo "‚ùå Server failed to start"
          exit 1
        fi
    
    - name: Install Frontend Dependencies
      run: |
        if [ -d "frontend" ]; then
          cd frontend
          npm ci
        else
          echo "‚ö†Ô∏è Frontend directory not found"
        fi
    
    - name: Build Frontend
      run: |
        if [ -d "frontend" ]; then
          cd frontend
          CI=false npm run build
          echo "‚úÖ Frontend built successfully"
        else
          echo "‚ö†Ô∏è Frontend directory not found, skipping build"
        fi
    
    - name: Check for Common Issues
      run: |
        echo "üîç Checking for common issues..."
        
        # Check for hardcoded credentials
        if grep -r "localhost:5000" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx"; then
          echo "‚ö†Ô∏è Found hardcoded localhost:5000 references"
        fi
        
        # Check for console.log in production code
        if find . -name "*.js" -not -path "./node_modules/*" -exec grep -l "console\." {} \; | head -5; then
          echo "‚ö†Ô∏è Found console.log statements"
        fi
        
        echo "‚úÖ Basic checks completed"